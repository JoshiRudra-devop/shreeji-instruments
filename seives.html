<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="img/png" href="logo.png" />
    <link rel="stylesheet" href="general.css" />
    <title>TEST SEIVES Calibration</title>
</head>
<body>
  <nav>
    <a href="index.html" style="display: flex; align-items: center; text-decoration: none;">
      <img src="https://github.com/JoshiRudra-devop/shreeji-instruments/blob/main/logo.png?raw=true" alt="Company Logo" style="width: 40px; border-radius:30%; height: 40px; margin-right: 10px;">
      <h1 style="color: white; margin: 0;">SHREEJI INSTRUMENTS</h1>
    </a>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="#footer">About</a></li>
      <li><a href="contactUs.html">Contact Us</a></li>
    </ul>
  </nav>
  <button class="back-button" onclick="goBackOrPromptSave()">‚Üê Back</button>
  <button class="dock-toggle" onclick="toggleDock()">‚ò∞ Actions</button>
  <div class="side-dock" id="sideDock">
    <h3>Actions</h3>
    <button class="dock-button" type="button" onclick="preview()">
      üìã Preview Certificate
    </button>
    <button class="dock-button" type="button" onclick="generatePDF()">
      üìÑ Download with Letterhead
    </button>
    <button class="dock-button" type="button" onclick="generatePDFblankpg()">
      üìù Download without Letterhead
    </button>
    <button class="dock-button" type="button" onclick="printBlankCertificate()">
      üñ®Ô∏è Print without Letterhead
    </button>
    <button class="dock-button sticker-btn" type="button" onclick="generateInfoSticker()">
      üè∑Ô∏è Generate Info Sticker
    </button>
    <button class="dock-button" id="downloadStickerBtn" type="button" onclick="downloadSticker()" style="display: none;">
      ‚¨áÔ∏è Download Sticker
    </button>
    <button class="dock-button" type="button" onclick="sharePDF()">
      üì§ Share PDF (With Letterhead)
    </button>
  </div>
  <div class="container">
      <h2 class="centered">TEST SEIVES CALIBRATION CERTIFICATE</h2>
      <form id="calibrationForm">
        <div class="title_input_pair">
          <label for="certificateNumber">Certificate No:</label>
          <input type="text" id="certificateNumber" required>
        </div>
        <div class="date">
                    <div class="title_input_pair">
                        <label for="calibrationDate">Date of Calibration:</label>
                        <input type="date" id="calibrationDate" onchange="calculateNextDate()" required>
                    </div>
                    <div class="title_input_pair">
                        <label for="nextCalibrationDate">Next Suggested Date:</label>
                        <input type="date" id="nextCalibrationDate" required>
                    </div>
                </div>
        <div class="title_input_pair">
          <label for="partyName">Name of Party:</label>
          <input type="text" id="partyName" required>
        </div>
        
        <div class="title_input_pair">
          <label for="siteLocation">Site Location:</label>
          <input type="text" id="siteLocation" required>
        </div>
        <div class="date">
          <div class="title_input_pair">
            <label for="sieveSize">SELECT SIZE OF SEIVE:</label>
            <select id="sieveSize" required>
              <option value="">Select type of Seive</option>
              <option value='Brass 200 MM DIA'>BRASS SEIVE 8"</option>
              <option value='GI 300 MM DIA'>GI SEIVE 12"</option>
              <option value='GI 450 MM DIA'>GI SEIVE 18"</option>
            </select>
          </div>
          <div class="title_input_pair">
            <label for="make">MAKE:</label>
            <select id="make" required>
              <option value="">Select MAKE</option>
              <option value='ASC'>ASC</option>
              <option value='STANDARD'>STANDARD</option>
            </select> 
          </div>
        </div>
        <div id="subSizes" style="display:none; border: 2px solid #00796b; border-radius: 10px; padding: 20px; margin: 10px 0; background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; color: #00796b;">Select Sub-Sizes:</h3>
          <div id="checkBoxes" style="display: flex; flex-wrap: wrap; gap: 15px;"></div>
          <button id="selectFullSetBtn" style="margin-top: 15px; padding: 10px 20px; background-color: #00796b; color: white; border: none; border-radius: 5px; cursor: pointer;">SELECT FULL SET</button>
        </div>
        <div id="testResults">
          <h3>Test Results</h3>
          <table id="resultsTable" style="display:none;">
            <thead>
              <tr>
                <th>SR NO.</th>
                <th>MAKE</th>
                <th>SEIVE</th>
                <th>SEIVE SIZE</th>
                <th>RESULT</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
          </table>
          <div id="selectedSizes" style="border: 2px solid #00796b; border-radius: 10px; padding: 20px; margin: 10px 0; background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #00796b;">Selected Sub-Sizes:</h3>
            <div id="selectedList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
          </div>
        </div>
        <div class="unsaved-reminder" id="unsavedReminder">
          <span>‚ö†Ô∏è Please save your certificate before leaving this page.</span>
        </div>
        <div class="sticker-section">
          <div class="sticker-preview-container">
            <h3 style="color: #00796b; margin-top: 0;">Info Sticker Preview</h3>
            <iframe id="stickerPreviewFrame"></iframe>
          </div>
        </div>
      </form>
    </div>
    <script src="general.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <script> 
    let stickerPdfBlob = null;
  
    function getFormDetails() {
      return {
        certificateNumber: document.getElementById("certificateNumber").value,
        calibrationDate: document.getElementById("calibrationDate").value.split("-").reverse().join("/"),
        siteLocation: document.getElementById("siteLocation").value,
        partyName: document.getElementById("partyName").value,
        nextCalibrationDate: document.getElementById("nextCalibrationDate").value.split("-").reverse().join("/"),
        make: document.getElementById("make").value,
        sieveSize: document.getElementById("sieveSize").value,
      };
    }

    function parseSize(size) {
      const match = size.match(/(\d+(?:\.\d+)?)/);
      if (!match) return 0;
      const num = parseFloat(match[1]);
      if (size.includes('Œºm') || size.includes('MICRON') || size.includes('microns')) return num / 1000; // convert to mm for sorting
      return num;
    }

    function getFullSet(size) {
      const fullSets = {
        'Brass 200 MM DIA': ['4.75 MM', '2.36 MM', '1.18 MM', '600 MICRON', '300 MICRON', '150 MICRON', '10 MICRON'],
        'GI 300 MM DIA': ['125mm', '100mm', '80mm', '63mm', '50mm', '40mm', '25mm', '16mm'],
        'GI 450 MM DIA': ['125mm', '100mm', '80mm', '63mm', '50mm', '40mm', '25mm', '16mm']
      };
      return fullSets[size] || [];
    }

    function getSubSizes(size) {
      const sizes = {
        'Brass 200 MM DIA': ['4.75 MM', '2.36 MM', '1.18 MM', '10 MM', '150 MICRON', '300 MICRON', '600 MICRON', '75 MICRON', '90 MICRON', '425 MICRON', '1 MM', '3.35 mm', '2.80 mm', '2.00 mm', '1.70 mm', '1.40 mm', '850 microns', '710 microns', '500 microns', '355 microns', '250 microns', '212 microns', '180 microns', '125 microns', '106 microns', '63 microns', '53 microns', '10 MICRON'],
        'GI 300 MM DIA': ['125mm', '106mm', '100mm', '90mm', '80mm', '75mm', '63mm', '53mm', '50mm', '45mm', '40mm', '37.5mm', '31.5mm', '26.5mm', '25mm', '22.4mm', '20mm', '19mm', '16mm', '13.2mm', '12.5mm', '11.2mm', '10mm', '9.5mm', '8mm', '6.7mm', '6.3mm', '5.6mm', '4.75mm'],
        'GI 450 MM DIA': ['125mm', '106mm', '100mm', '90mm', '80mm', '75mm', '63mm', '53mm', '50mm', '45mm', '40mm', '37.5mm', '31.5mm', '26.5mm', '25mm', '22.4mm', '20mm', '19mm', '16mm', '13.2mm', '12.5mm', '11.2mm', '10mm', '9.5mm', '8mm', '6.7mm', '6.3mm', '5.6mm', '4.75mm']
      };
      return sizes[size] || [];
    }

    function updateSelectedDisplay() {
      const selectedList = document.getElementById('selectedList');
      selectedList.innerHTML = '';
      const tbody = document.getElementById('resultsBody');
      for (let row of tbody.rows) {
        const size = row.cells[3].textContent;
        const item = document.createElement('span');
        item.style.display = 'inline-flex';
        item.style.alignItems = 'center';
        item.style.padding = '5px 10px';
        item.style.border = '1px solid #ccc';
        item.style.borderRadius = '5px';
        item.style.backgroundColor = '#fff';
        item.innerHTML = '‚úì ' + size;
        selectedList.appendChild(item);
      }
    }

    function updateSubSizes() {
      const size = document.getElementById('sieveSize').value;
      const subSizesDiv = document.getElementById('subSizes');
      const checkBoxesDiv = document.getElementById('checkBoxes');
      const tbody = document.getElementById('resultsBody');
      if (!size) {
        subSizesDiv.style.display = 'none';
        tbody.innerHTML = '';
        updateSelectedDisplay();
        return;
      }
      // Auto-select MAKE based on sieve size
      const makeSelect = document.getElementById('make');
      if (size === 'Brass 200 MM DIA') {
        makeSelect.value = 'STANDARD';
      } else {
        makeSelect.value = 'ASC';
      }
      updateMake(); // Update existing rows with new make
      subSizesDiv.style.display = 'block';
      tbody.innerHTML = '';
      updateSelectedDisplay();
      checkBoxesDiv.innerHTML = '';
      const subSizes = getSubSizes(size);
      subSizes.sort((a, b) => parseSize(b) - parseSize(a));
      subSizes.forEach(sub => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.padding = '5px 10px';
        label.style.border = '1px solid #ccc';
        label.style.borderRadius = '5px';
        label.style.backgroundColor = '#fff';
        label.style.cursor = 'pointer';
        label.style.transition = 'background-color 0.3s';
        label.onmouseover = () => label.style.backgroundColor = '#e0f2f1';
        label.onmouseout = () => label.style.backgroundColor = '#fff';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = sub;
        checkbox.style.marginRight = '5px';
        checkbox.onchange = () => toggleRow(sub, checkbox.checked);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(sub));
        checkBoxesDiv.appendChild(label);
      });
      // Add onclick to SELECT FULL SET button
      document.getElementById('selectFullSetBtn').onclick = () => {
        const fullSet = getFullSet(size);
        const checkboxes = document.querySelectorAll('#checkBoxes input[type="checkbox"]');
        checkboxes.forEach(cb => {
          if (fullSet.includes(cb.value)) {
            cb.checked = true;
            toggleRow(cb.value, true);
          }
        });
      };
    }

    function toggleRow(subSize, checked) {
      const tbody = document.getElementById('resultsBody');
      const make = document.getElementById('make').value;
      const seive = document.getElementById('sieveSize').value;
      if (checked) {
        const row = tbody.insertRow();
        const srCell = row.insertCell();
        srCell.textContent = tbody.rows.length;
        const makeCell = row.insertCell();
        makeCell.textContent = make;
        const seiveCell = row.insertCell();
        seiveCell.textContent = seive;
        const sizeCell = row.insertCell();
        sizeCell.textContent = subSize;
        const resultCell = row.insertCell();
        resultCell.textContent = 'OK';
      } else {
        for (let i = 0; i < tbody.rows.length; i++) {
          if (tbody.rows[i].cells[3].textContent === subSize) {
            tbody.deleteRow(i);
            for (let j = i; j < tbody.rows.length; j++) {
              tbody.rows[j].cells[0].textContent = j + 1;
            }
            break;
          }
        }
      }
      updateSelectedDisplay();
    }

    function updateMake() {
      const make = document.getElementById('make').value;
      document.querySelectorAll('#resultsBody tr').forEach(row => {
        row.cells[1].textContent = make;
      });
    }

    document.getElementById('sieveSize').addEventListener('change', updateSubSizes);
    document.getElementById('make').addEventListener('change', updateMake);
  function addTestResultRow() {
      const testResults = document.getElementById('testResults');
      const currentRows = testResults.getElementsByClassName('test-result').length;
      const row = document.createElement('div');
      row.className = 'test-result';
      row.innerHTML = `<input type="text" placeholder="Sieves NUMBER" required>`;
      testResults.appendChild(row);
    }
function addCertificateDetails(doc, details)
     {
      const testResults = [];
      document.querySelectorAll('#resultsBody tr').forEach(row => {
        const cells = row.cells;
        testResults.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent]);
      });

      // Sort by size descending
      testResults.sort((a, b) => parseSize(b[3]) - parseSize(a[3]));

      // Reassign SR NO.
      testResults.forEach((row, index) => {
        row[0] = (index + 1).toString();
      });

      let isFirstPage = true;
      let currentY = 50;
      let currentCertNo = parseInt(details.certificateNumber) || 0;

      while (testResults.length > 0) {
        if (!isFirstPage) {
          doc.addPage();
          currentY = 50;
          currentCertNo++;
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(25);   
        doc.text("CALIBRATION CERTIFICATE", doc.internal.pageSize.getWidth()/2, currentY, { align: 'center' });

        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(12);  

        currentY += 5;
        doc.text(`NAME OF PARTY           :-     ${details.partyName}`, 14, currentY);
        currentY += 5;
        doc.text(`REF NO:- SI-${currentCertNo}`, 140, currentY);
        doc.text(`EQUIPMENT NAME        :-     TEST SEIVES`, 14, currentY);
        currentY += 5;
        doc.text(`SITE LOCATION             :-     ${details.siteLocation}`, 14, currentY);
        currentY += 5;
        doc.text(`CALIBRATION DATE     :-     ${details.calibrationDate}`, 14, currentY);
        currentY += 5;
        doc.text(`NEXT DUE DATE            :-     ${details.nextCalibrationDate}`, 14, currentY);
        currentY += 5;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);   
        doc.text("Test Results", doc.internal.pageSize.getWidth()/2, currentY, { align: 'center' });
        currentY += 3;

        const chunk = testResults.splice(0, 9);

        doc.autoTable({
          head: [['SR NO.', 'MAKE', 'SEIVE', 'SEIVE SIZE', 'RESULT']],
          body: chunk,
          startY: currentY,
          styles: { 
            fontSize: 8 ,
            textColor: [0,0,0],
            fontStyle:"bold",  
            lineColor:[87, 86, 85],
            lineWidth: 0.2,
            halign: 'center',
            valign: 'middle',
          },
          headStyles: {
            fontSize: 10,
            fillColor: [255, 255, 255],
            textColor: [0,0,0],
            lineColor: [0, 0, 0],
            lineWidth: 0.2,
            halign: 'center',
            valign: 'middle',
          },
          alternateRowStyles: {
            fillColor: [255, 255, 255]
          }
        });

        currentY = doc.autoTable.previous.finalY + 3;
        isFirstPage = false;

        let yPosition = currentY;
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.text("*REMARKS:-", doc.internal.pageSize.getWidth()/2, yPosition+=2, { align: 'center' }); yPosition += 5;
        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(8);
        doc.text("‚Ä¢THESE RESULTS ARE OBTAINED AT THE TIME OF CALIBRATION.", 14, yPosition); yPosition += 5;
        doc.text("‚Ä¢ANY HAND WRITTEN CORRECTION (EXCEPT @ OR PHOTOCOPIES OF THE REPORT INVALIDATES THIS CERTIFICATE).", 14, yPosition); yPosition += 5;
        doc.text("‚Ä¢ENVIRONMENT CONDITION DURING CALIBRATION: 20 + 2.C, 40 TO 60% RH.", 14, yPosition); yPosition += 5;
        doc.text("‚Ä¢THE UNCERTAINTIES ARE FOR A CONFIDENCE PROBABILITY OF NOT LESS THAN 95%. ", 14, yPosition); yPosition += 5;
        doc.text("‚Ä¢REFERENCE CALIBRATION METHOD NO: NCQC/CM/102.", 14, yPosition); yPosition += 5;
        doc.text("‚Ä¢REFERENCE STANDARD NO.IS-2-1960.", 14, yPosition); yPosition += 7;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.text("*DETAILS OF OUR MASTER INSTRUMENT THROUGH WHICH SEIVES ARE CALIBRATED", doc.internal.pageSize.getWidth()/2, yPosition, { align: 'center' }); yPosition += 7;
        doc.setFont("helvetica", "bold");       
        doc.setFontSize(8);

        doc.text("NAME :DIGITAL VERNIAR CALIPER", 14, yPosition); yPosition += 5;
        doc.text(`SERIAL NO  :ACCUPLUS/13-200`, 124, yPosition);
        doc.text('RANGE:0-200MM', 14, yPosition); yPosition += 5;
        doc.text(`LEAST COUNT:0.001"(O.O1MM)`, 124, yPosition);
        doc.text('VALID UP TO DATE:03/07/2026', 14, yPosition); yPosition += 5;
        doc.text('OUR MASTER INSTRUMENT IS CALIBRATED AND TRACEABLE TO NATIONAL STANDARD THROUGH NABL ACCREDITED ', 14, yPosition); yPosition += 5;
        doc.text('LABORATORY "IDEMI CALIBRATION LABORATORY."', 14, yPosition); yPosition += 5;
        doc.text('CERTIFICATE NUMBER:-62', 14, yPosition); yPosition += 5;

        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(12); 
        doc.text("FOR, SHREEJI INSTRUMENTS", 145, 230);
        doc.text("PROPRIETOR", 170, 245);
      }

      // No signature here anymore
    }
   async function generateInfoSticker() {
      const { jsPDF } = window.jspdf;
      const width = 40 * 2.83465;
      const height = 30 * 2.83465;
      const doc = new jsPDF({
        orientation: "landscape",
        unit: "pt",
        format: [width, height]
      });
      const details = getFormDetails();
      const primaryBlue = [19, 52, 165];
      const accentRed = [228, 34, 21];
      doc.setDrawColor(...primaryBlue);
      doc.setLineWidth(3);
      doc.rect(5, 5, width - 10, height - 10);
      const logoImg = new Image();
      logoImg.src = "logo.jpeg";
      await new Promise(resolve => { logoImg.onload = resolve; logoImg.onerror = resolve; });
      if (logoImg.width) {
        doc.addImage(logoImg, "JPEG", 20, 7, 5, 7);
      }
      doc.setFont("times", "bold");
      doc.setFontSize(8);
      doc.setTextColor(...accentRed);
      doc.text("Shreeji Instruments", 32, 13);
      doc.setFont("times", "normal");
      doc.setFontSize(4);
      doc.setTextColor(...primaryBlue);
      doc.text("SALES ‚Ä¢ SERVICE ‚Ä¢ REPAIRING ‚Ä¢ CALIBRATIONS", width / 2, 18, { align: "center" });
      const tableLeft = 15;
      const tableTop = 20;
      const tableWidth = width - 30;
      const rowHeight = 14;
      const labelWidth = tableWidth * 0.4;
      const tableData = [
        { label: "INST. ID NO.", value: details.serialNo || "N/A" },
        { label: "MODEL", value: details.modelNo || "N/A" },
        { label: "CALIB. DATE", value: details.calibrationDate || "N/A" },
        { label: "NEXT DATE", value: details.nextCalibrationDate || "N/A" },
      ];
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(1);
      doc.rect(tableLeft, tableTop, tableWidth, rowHeight * tableData.length);
      tableData.forEach((row, index) => {
        const rowY = tableTop + (index * rowHeight);
        if (index > 0) doc.line(tableLeft, rowY, tableLeft + tableWidth, rowY);
        doc.line(tableLeft + labelWidth, rowY, tableLeft + labelWidth, rowY + rowHeight);
        doc.setFillColor(255, 255, 255);
        doc.rect(tableLeft, rowY, labelWidth, rowHeight, 'F');
        const labelY = rowY + rowHeight / 2 + 1;
        const valueY = rowY + rowHeight / 2 + 1;
        doc.setFont("times", "bold");
        doc.setFontSize(4.5);
        doc.setTextColor(...primaryBlue);
        doc.text(row.label, tableLeft + 4, labelY, { baseline: 'middle' });
        doc.setFont("times", "normal");
        doc.setFontSize(4.5);
        doc.setTextColor(0, 0, 0);
        doc.text(row.value, tableLeft + labelWidth + 5, valueY, { baseline: 'middle' });
      });
      stickerPdfBlob = doc.output('blob');
      const pdfURL = URL.createObjectURL(stickerPdfBlob);
      const frame = document.getElementById("stickerPreviewFrame");
      frame.src = pdfURL;
      frame.style.display = "block";
      const dockDownloadBtn = document.querySelector('.side-dock #downloadStickerBtn');
      dockDownloadBtn.style.display = "block";
      frame.scrollIntoView({ behavior: 'smooth' });
    }
    async function downloadSticker() {
      if (!stickerPdfBlob) {
        alert('Please generate the sticker first!');
        return;
      }
      const details = getFormDetails();
      const fileName = `InfoSticker_${details.serialNo || 'Unknown'}_${details.make || 'Unknown'}.pdf`;
      await savePDFWithLocation(stickerPdfBlob, fileName);
    }
  </script>
</body>
</html>
